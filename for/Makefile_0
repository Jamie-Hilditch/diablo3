# Fortran 90 complier to use: gfortran or ifort
COMPILER = gfortran

# FFTW3 library to Link
FFTW_LIB = /share/software/user/open/fftw/3.3.10/lib

# FFTW include directory
FFTW_INCLUDE = /share/software/user/open/fftw/3.3.10/include

# Shared memory
SHARED_MEMORY = TRUE

# Compiler Options
FCFLAGS = -O3
#FCFLAGS = -O0 -g -check all -traceback -debug extended # Debug


#############################################################################

LDFLAGS += -L$(FFTW_LIB) -lfftw3 -lgfortran

# Preprocessing, link time and architecture optimisation (compiler dependent)
ifeq ($(COMPILER),ifort)
  FCFLAGS += -fpp -ipo -xHost
else ifeq ($(COMPILER),gfortran)
  FCFLAGS += -cpp -march=native -flto
endif

# Include FFTW
FCFLAGS += -I$(FFTW_INCLUDE)

# Shared memory
ifeq ($(SHARED_MEMORY),TRUE)
  FCFLAGS += -DSHARED_MEMORY
endif

# Parallel HDF5 compiler wrapper
COMPILER = h5pfc

SOURCES = domain.o fft.o flow.o parameters.o tools.o

diablo: diablo.f90 $(SOURCES)
	$(COMPILER) $(FCFLAGS) $^ -o $@ $(LDFLAGS)

%.o: %.f90
	$(COMPILER) $(FCFLAGS) -c $<



domain.o: domain.f90 grid_def grid_mpi

fft.o: fft.f90 domain.o

flow.o: flow.f90 fft.o domain.o parameters.o tools.o \
				diagnostics.f90 les.f90 phdf5.f90 solver.f90

parameters.o: parameters.f90 fft.o domain.o

tools.o: tools.f90 domain.o parameters.o


.PHONY: clean
clean:
	-rm -f *.o *.mod diablo
